# Интеграция Росдомофон для Home Assistant

Интеграция позволяет управлять устройствами Росдомофон (двери подъезда, шлагбаумы, ворота, калитки) из Home Assistant через облачный API Росдомофон.

## Возможности

- Управление замками Росдомофон как сущностями типа `lock` в Home Assistant.
- Поддержка нескольких типов устройств: дверь подъезда, шлагбаум, ворота, калитка (отдельные сущности с разными иконками).
- **Гостевые ссылки** — генерация временных ссылок для открытия двери гостям без доступа к Home Assistant.

## Требования

- Home Assistant **2023.9+**.
- Аккаунт в сервисе **Росдомофон** с привязанным номером телефона РФ.
- Установленный **HACS** (Home Assistant Community Store).

## Установка через HACS

1. Откройте **HACS → Integrations** в интерфейсе Home Assistant.
2. Нажмите кнопку **⋮ (три точки)** в правом верхнем углу и выберите **Custom repositories**.
3. В поле **Repository** укажите URL репозитория:
   - `https://github.com/iljyxa/rosdomofon-ha`
4. В поле **Category** выберите **Integration** и нажмите **Add**.
5. Найдите интеграцию **Росдомофон** в списке HACS.
6. Нажмите **Install** и перезагрузите Home Assistant.

## Настройка интеграции

1. Перейдите в **Настройки → Устройства и службы → Добавить интеграцию**.
2. Найдите **Росдомофон** (или `rosdomofon`).
3. Введите номер телефона РФ (можно в любом формате: `+7 (999) 123-45-67`, `89991234567` и т.д.).
4. Введите код из SMS.
5. После успешной авторизации будут созданы сущности замков и кнопки «Поделиться» для каждого замка.

## Гостевые ссылки (Поделиться)

Интеграция позволяет создавать временные ссылки для открытия двери гостями без доступа к Home Assistant.

### Кнопка «Поделиться»

Для каждого замка автоматически создаётся кнопка `button.rosdomofon_share_<id>`. При нажатии:

1. Генерируется уникальная ссылка со сроком действия **12 часов**.
2. Ссылка отображается в уведомлении Home Assistant — скопируйте её и отправьте гостю.
3. Гость переходит по ссылке в браузере — открывается страница с кнопкой «ОТКРЫТЬ» и информацией о том, сколько ещё действует ключ.
4. При нажатии на кнопку на странице выполняется попытка открыть замок; при успехе гость видит статус «ОТКРЫТО», при ошибке — «ОШИБКА» и текст ошибки.
5. По истечении срока ссылка автоматически деактивируется.

### Сервис `rosdomofon.generate_share_link`

Альтернативно можно вызвать сервис из автоматизаций или инструментов разработчика:

```yaml
service: rosdomofon.generate_share_link

  entity_id: lock.rosdomofon_12345_1
  ttl_hours: 12
```

Параметры:

| Параметр | Описание | По умолчанию |
|-----------|----------|---------------|
| `entity_id` | Entity ID замка Росдомофон | Обязательный |
| `ttl_hours` | Срок действия ссылки в часах (0.5–168) | 12 |

### Требования для гостевых ссылок

- Должен быть настроен **внешний доступ** к Home Assistant (External URL или Nabu Casa).
- Если внешний доступ не настроен, при нажатии кнопки появится уведомление с инструкцией.

### Безопасность

- Каждая ссылка содержит уникальный UUID и не требует авторизации в HA.
- Ссылка автоматически деактивируется по истечении срока.
- При выгрузке / удалении интеграции все активные ссылки отзываются.
- Рекомендуется использовать HTTPS для внешнего доступа.

## Отладка и диагностика

Интеграция использует логгер `custom_components.rosdomofon`. Для подробной диагностики:

```yaml
logger:
  default: warning
  logs:
    custom_components.rosdomofon: debug
```
