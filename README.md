# Интеграция Росдомофон для Home Assistant

Интеграция позволяет управлять устройствами Росдомофон (двери подъезда, шлагбаумы, ворота, калитки), а также просматривать камеры видеонаблюдения из Home Assistant через облачный API Росдомофон.

## Возможности

- **Управление замками** — замки Росдомофон как сущности типа `lock` в Home Assistant.
- **Поддержка нескольких типов устройств**: дверь подъезда, шлагбаум, ворота, калитка (отдельные сущности с разными иконками).
- **Гостевые ссылки** — генерация временных ссылок для открытия двери гостям без доступа к Home Assistant.
- **Камеры видеонаблюдения** — просмотр HLS потоков с камер Росдомофон в интерфейсе Home Assistant.

## Требования

- Home Assistant **2023.9+**.
- Аккаунт в сервисе **Росдомофон** с привязанным номером телефона РФ.
- Установленный **HACS** (Home Assistant Community Store).

## Установка через HACS

1. Откройте **HACS → Integrations** в интерфейсе Home Assistant.
2. Нажмите кнопку **⋮ (три точки)** в правом верхнем углу и выберите **Custom repositories**.
3. В поле **Repository** укажите URL репозитория:
   - `https://github.com/iljyxa/rosdomofon-ha`
4. В поле **Category** выберите **Integration** и нажмите **Add**.
5. Найдите интеграцию **Росдомофон** в списке HACS.
6. Нажмите **Install** и перезагрузите Home Assistant.

## Настройка интеграции

1. Перейдите в **Настройки → Устройства и службы → Добавить интеграцию**.
2. Найдите **Росдомофон** (или `rosdomofon`).
3. Введите номер телефона РФ (можно в любом формате: `+7 (999) 123-45-67`, `89991234567` и т.д.).
4. Введите код из SMS.
5. После успешной авторизации будут созданы сущности замков и кнопки «Поделиться» для каждого замка.

## Гостевые ссылки (Поделиться)

Интеграция позволяет создавать временные ссылки для открытия двери гостями без доступа к Home Assistant.

### Кнопка «Поделиться»

Для каждого замка автоматически создаётся кнопка `button.rosdomofon_share_<id>`. При нажатии:

1. Генерируется уникальная ссылка со сроком действия **12 часов**.
2. Ссылка отображается в уведомлении Home Assistant — скопируйте её и отправьте гостю.
3. Гость переходит по ссылке в браузере — открывается страница с кнопкой «ОТКРЫТЬ» и информацией о том, сколько ещё действует ключ.
4. При нажатии на кнопку на странице выполняется попытка открыть замок; при успехе гость видит статус «ОТКРЫТО», при ошибке — «ОШИБКА» и текст ошибки.
5. По истечении срока ссылка автоматически деактивируется.

### Сервис `rosdomofon.generate_share_link`

Альтернативно можно вызвать сервис из автоматизаций или инструментов разработчика:

```yaml
service: rosdomofon.generate_share_link

  entity_id: lock.rosdomofon_12345_1
  ttl_hours: 12
```

Параметры:

| Параметр    | Описание                               | По умолчанию |
|-------------|----------------------------------------|--------------|
| `entity_id` | Entity ID замка Росдомофон             | Обязательный |
| `ttl_hours` | Срок действия ссылки в часах (0.5–168) | 12           |

### Требования для гостевых ссылок

- Должен быть настроен **внешний доступ** к Home Assistant (External URL или Nabu Casa).
- Если внешний доступ не настроен, при нажатии кнопки появится уведомление с инструкцией.

### Безопасность

- Каждая ссылка содержит уникальный UUID и не требует авторизации в HA.
- Ссылка автоматически деактивируется по истечении срока.
- При выгрузке / удалении интеграции все активные ссылки отзываются.
- Рекомендуется использовать HTTPS для внешнего доступа.

## Камеры видеонаблюдения

Интеграция автоматически обнаруживает камеры, привязанные к вашему аккаунту Росдомофон, и создаёт для них сущности типа `camera`.

### Возможности камер

- Просмотр живого HLS потока в интерфейсе Home Assistant
- Автоматическая авторизация запросов через встроенный прокси-сервер
- Поддержка просмотра через веб-интерфейс и мобильные приложения Home Assistant
- Интеграция с картами (Lovelace) и панелями мониторинга

### Технические требования

#### Для локального просмотра
- Браузер с поддержкой HLS (Safari, Edge) или расширение для Chrome/Firefox
- Home Assistant должен быть доступен по HTTPS (для корректной работы медиа-потоков)

#### Для удалённого просмотра
- Настроенный **внешний доступ** (External URL) или **Home Assistant Cloud** (Nabu Casa)
- HTTPS соединение (обязательно для безопасной передачи видео)

### Как работает прокси

Для просмотра потоков с камер Росдомофон требуется авторизация по Bearer токену. Интеграция автоматически:

1. Перехватывает запросы к HLS потокам камер
2. Добавляет заголовок `Authorization` с актуальным токеном
3. Переписывает URL в плейлистах для корректной работы
4. Возвращает поток клиенту

Дополнительно потоковый URL в Home Assistant подписывается (signed URL), чтобы стрим-воркер мог получать доступ без логина в UI. На старых версиях HA, где подпись недоступна, используется обычный (неподписанный) URL.

Всё это происходит прозрачно — вам не нужно ничего настраивать вручную.

### Использование в картах Lovelace

```yaml
type: picture-glance
camera_image: camera.rosdomofon_camera_39167
entities:
  - lock.rosdomofon_entrance_door
  - button.rosdomofon_share_entrance_door
```

Или для просмотра потока:

```yaml
type: custom:webrtc-camera
entity: camera.rosdomofon_camera_39167
```

## Примеры автоматизаций

### Автоматическое создание гостевой ссылки по расписанию

```yaml
automation:
  - alias: "Гостевая ссылка для курьера"
    description: "Создаёт временную ссылку каждое утро для курьера"
    trigger:
      - platform: time
        at: "09:00:00"
    condition:
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
    action:
      - service: rosdomofon.generate_share_link
        
          entity_id: lock.rosdomofon_entrance_door
          ttl_hours: 2
      - service: notify.telegram
        
          message: "Ссылка для открытия двери создана и действует до 11:00"
```

## Отладка и диагностика

Интеграция использует логгер `custom_components.rosdomofon`. Для подробной диагностики:

```yaml
logger:
  default: warning
  logs:
    custom_components.rosdomofon: debug
```

## Безопасность

- Все запросы к API Росдомофон используют HTTPS
- Токены доступа хранятся в защищённом хранилище Home Assistant
- Гостевые ссылки содержат уникальный UUID и автоматически истекают
- Рекомендуется использовать HTTPS для внешнего доступа к Home Assistant
